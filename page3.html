<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>UBHACKOPOLY ‚Äì Game Board</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body {
    height: 100%;
    font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: radial-gradient(circle at top, #0b1335, #02040a 85%);
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }
  .game-container {
    display: grid;
    grid-template-columns: 22% 53% 25%;
    width: min(96vw, 1600px);
    height: min(96vh, 1000px);
    gap: 1rem;
  }
  .sidebar {
    backdrop-filter: blur(18px);
    background: rgba(255, 255, 255, 0.08);
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 1rem;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    overflow-y: auto;
  }
  .sidebar h2 { display: flex; align-items: center; gap: 10px; font-size: clamp(1rem, 1.6vw, 1.4rem); color: #b6e7ff; text-shadow: 0 0 10px rgba(0,180,255,0.6); margin-bottom: 10px; }
  .player-card {
    background: rgba(255,255,255,0.08);
    border-radius: 12px;
    margin-bottom: 0.6rem;
    padding: 0.8rem;
    border-left: 6px solid;
    display: flex; justify-content: space-between; align-items: center;
    transition: all .25s ease;
  }
  .player-card.active { background: linear-gradient(135deg, #007bff, #5e1fff); transform: scale(1.03); box-shadow: 0 0 14px #2196f3cc; }
  .player-info { flex: 1; min-width: 0; }
  .player-name { font-weight: 700; font-size: clamp(.9rem, 1.5vw, 1rem); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .player-balance { font-size: .9rem; opacity: .9; }
  .player-piece { width: 42px; height: 42px; display: grid; place-items: center; margin-left: 10px; }
  .player-piece img { width: 36px; height: 36px; object-fit: contain; filter: drop-shadow(0 2px 6px rgba(0,0,0,.4)); }

  .board-wrap {
    position: relative; border-radius: 18px; background: rgba(0,0,0,.25);
    padding: 12px; box-shadow: 0 0 30px rgba(0,150,255,.4) inset;
    border: 4px solid #00aaff; display: grid; grid-template-rows: 1fr; grid-template-columns: 1fr;
  }
  .board-image { grid-area: 1 / 1 / 2 / 2; position: relative; width: 100%; aspect-ratio: 1 / 1; border-radius: 12px; overflow: hidden; }
  .board-image img { width: 100%; height: 100%; object-fit: contain; display: block; user-select: none; pointer-events: none; }
  .board {
    grid-area: 1 / 1 / 2 / 2; position: absolute; inset: 0;
    display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr);
    border-radius: 12px; pointer-events: none;
  }
  .tile { display:flex; align-items:center; justify-content:center; font-size: clamp(9px, 0.85vw, 13px); text-align:center; padding:4px; user-select:none; background:transparent!important; border:1px solid transparent!important; pointer-events:auto; cursor:pointer; transition: box-shadow .18s ease, transform .12s ease; }
  .tile:hover { box-shadow: inset 0 0 0 3px rgba(0, 229, 255, .6); transform: scale(1.02); }
  .corner { font-weight: 800; }

  #go { grid-row:11; grid-column:11; } #justVisiting{ grid-row:11; grid-column:1; } #freeParking{ grid-row:1; grid-column:1; } #goToJail{ grid-row:1; grid-column:11; }
  #baird{ grid-row:11; grid-column:10; } #community1{ grid-row:11; grid-column:9; } #clements{ grid-row:11; grid-column:8; } #saFees{ grid-row:11; grid-column:7; } #northBus{ grid-row:11; grid-column:6; } #baldy{ grid-row:11; grid-column:5; } #chance1{ grid-row:11; grid-column:4; } #jacobs{ grid-row:11; grid-column:3; } #park{ grid-row:11; grid-column:2; }
  #obrian{ grid-row:10; grid-column:1; } #mtBanks{ grid-row:9; grid-column:1; } #norton{ grid-row:8; grid-column:1; } #knox{ grid-row:7; grid-column:1; } #southBus{ grid-row:6; grid-column:1; } #bonner{ grid-row:5; grid-column:1; } #community2{ grid-row:4; grid-column:1; } #talbert{ grid-row:3; grid-column:1; } #hochstetter{ grid-row:2; grid-column:1; }
  #cooke{ grid-row:1; grid-column:2; } #chance2{ grid-row:1; grid-column:3; } #fronczak{ grid-row:1; grid-column:4; } #nsc{ grid-row:1; grid-column:5; } #downtownBus{ grid-row:1; grid-column:6; } #ketter{ grid-row:1; grid-column:7; } #slee{ grid-row:1; grid-column:8; } #valmar{ grid-row:1; grid-column:9; } #furnas{ grid-row:1; grid-column:10; }
  #theCommons{ grid-row:2; grid-column:11; } #centerArts{ grid-row:3; grid-column:11; } #community3{ grid-row:4; grid-column:11; } #alumniArena{ grid-row:5; grid-column:11; } #shoppingBus{ grid-row:6; grid-column:11; } #chance3{ grid-row:7; grid-column:11; } #davis{ grid-row:8; grid-column:11; } #textbookFees{ grid-row:9; grid-column:11; } #jarvis{ grid-row:10; grid-column:11; }

  .token { position:absolute; width: clamp(18px, 3vw, 34px); height: clamp(18px, 3vw, 34px); transform: translate(-50%, -50%); z-index:15; filter: drop-shadow(0 4px 10px rgba(0,0,0,.5)); transition: left .18s linear, top .18s linear; pointer-events: none; }
  .token img { width:100%; height:100%; object-fit: contain; user-select:none; }

  .actions { backdrop-filter: blur(18px); background: rgba(255,255,255,.08); border:2px solid rgba(255,255,255,.15); border-radius:20px; padding:1.2rem; display:flex; flex-direction:column; gap:14px; box-shadow:0 8px 30px rgba(0,0,0,.3); }
  .actions button { width:100%; padding:14px; border:none; border-radius:12px; background:linear-gradient(135deg,#007bff,#4a00e0); color:#fff; font-weight:700; font-size:clamp(.9rem,1.2vw,1rem); cursor:pointer; box-shadow:0 0 18px rgba(0,136,255,.3); transition: all .25s ease; }
  .actions button:hover { background:linear-gradient(135deg,#00b0ff,#5e1fff); transform: translateY(-2px); box-shadow:0 0 25px rgba(90,50,255,.6); }
  .dice-display { text-align:center; font-weight:700; opacity:.9; min-height: 1.2em; }

  .popup { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #007bff, #00b3ff); color: white; padding: 15px 22px; border-radius: 12px; font-weight: 600; font-size: 1rem; box-shadow: 0 0 25px rgba(0, 180, 255, 0.5); opacity: 0; transform: translateY(20px); transition: all 0.35s ease; z-index: 999; max-width: 320px; }
  .popup.show { opacity: 1; transform: translateY(0); }

  .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 900; }
  .modal{ width: min(92vw, 520px); background: #0c1630; border: 2px solid #1e3a8a; border-radius: 14px; box-shadow: 0 12px 30px rgba(0,0,0,.4); padding: 16px; }
  .modal h3{ margin-bottom: 10px; color:#bde3ff; }
  .modal .close{ float: right; background: transparent; border: none; color:#9ecbff; font-weight:700; cursor:pointer; }
  .prop-list{ display: grid; grid-template-columns: 1fr auto; gap: 8px; }
  .pill{ display:inline-block; padding: 6px 10px; border-radius:999px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); font-size: .9rem; }

  @media (max-width: 880px) {
    .game-container { grid-template-columns: 1fr; grid-template-rows: auto minmax(60vh, 68vh) auto; width: 98vw; height: auto; }
    .sidebar { order: 1; }
    .board-wrap { order: 2; min-height: 60vh; }
    .actions { order: 3; }
  }
</style>
</head>
<body>
<div class="game-container">
  <div class="sidebar" id="playerSidebar">
    <h2>üéÆ Players</h2>
  </div>

  <div class="board-wrap">
    <div class="board-image" id="boardImgHolder">
      <img src="Images/hackopoly board.png" alt="UBHACKOPOLY Board" />
    </div>

    <div class="board" id="board">
      <!-- Corners -->
      <div class="tile corner" id="go"           title="GO"></div>
      <div class="tile corner" id="justVisiting" title="Just Visiting"></div>
      <div class="tile corner" id="freeParking"  title="Free Parking"></div>
      <div class="tile corner" id="goToJail"     title="Go To Jail"></div>

      <!-- Bottom row -->
      <div class="tile" id="baird"        title="Baird"></div>
      <div class="tile" id="community1"   title="Community Chest"></div>
      <div class="tile" id="clements"     title="Clements"></div>
      <div class="tile" id="saFees"       title="SA Fees"></div>
      <div class="tile" id="northBus"     title="North Bus"></div>
      <div class="tile" id="baldy"        title="Baldy"></div>
      <div class="tile" id="chance1"      title="Chance"></div>
      <div class="tile" id="jacobs"       title="Jacobs"></div>
      <div class="tile" id="park"         title="Park"></div>

      <!-- Left -->
      <div class="tile" id="obrian"       title="O‚ÄôBrian"></div>
      <div class="tile" id="mtBanks"      title="M & T Banks"></div>
      <div class="tile" id="norton"       title="Norton"></div>
      <div class="tile" id="knox"         title="Knox"></div>
      <div class="tile" id="southBus"     title="South Bus"></div>
      <div class="tile" id="bonner"       title="Bonner"></div>
      <div class="tile" id="community2"   title="Community Chest"></div>
      <div class="tile" id="talbert"      title="Talbert"></div>
      <div class="tile" id="hochstetter"  title="Hochstetter"></div>

      <!-- Top -->
      <div class="tile" id="cooke"        title="Cooke"></div>
      <div class="tile" id="chance2"      title="Chance"></div>
      <div class="tile" id="fronczak"     title="Fronczak"></div>
      <div class="tile" id="nsc"          title="NSC"></div>
      <div class="tile" id="downtownBus"  title="Downtown Bus"></div>
      <div class="tile" id="ketter"       title="Ketter"></div>
      <div class="tile" id="slee"         title="Slee"></div>
      <div class="tile" id="valmar"       title="Valmar"></div>
      <div class="tile" id="furnas"       title="Furnas"></div>

      <!-- Right -->
      <div class="tile" id="theCommons"   title="The Commons"></div>
      <div class="tile" id="centerArts"   title="Center for the Arts"></div>
      <div class="tile" id="community3"   title="Community Chest"></div>
      <div class="tile" id="alumniArena"  title="Alumni Arena"></div>
      <div class="tile" id="shoppingBus"  title="Shopping Bus"></div>
      <div class="tile" id="chance3"      title="Chance"></div>
      <div class="tile" id="davis"        title="Davis"></div>
      <div class="tile" id="textbookFees" title="Textbook Fees"></div>
      <div class="tile" id="jarvis"       title="Jarvis"></div>
    </div>
  </div>

  <div class="actions">
    <button id="rollBtn">üé≤ Roll Dice</button>
    <div class="dice-display" id="diceDisplay">‚Äì</div>
    <button id="buyBtn">üí∞ Buy Property</button>
    <button id="propsBtn">üìú My Properties</button>
    <button id="useCardBtn" style="display:none">üéüÔ∏è Use Jail Card</button>
    <button id="endTurnBtn">‚û°Ô∏è End Turn</button>
    <button id="resetBtn">üîÑ Reset Game</button>
  </div>
</div>

<!-- My Properties Modal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="propsTitle">
  <div class="modal">
    <button class="close" id="modalClose">‚úñ</button>
    <h3 id="propsTitle">My Properties</h3>
    <div id="propList" class="prop-list"></div>
  </div>
</div>

<div class="popup" id="popup">Notification</div>

<script>
/* ===== API base forced to 5050 (works for file:// or localhost) ===== */
const API = (() => {
  try {
    const isFile = location.protocol === 'file:';
    const isLocal = ['localhost','127.0.0.1','0.0.0.0'].includes(location.hostname);
    if (isFile) return 'http://127.0.0.1:5050';
    if (isLocal) return `http://${location.hostname}:5050`;
    return `${location.origin}`;
  } catch {
    return 'http://127.0.0.1:5050';
  }
})();
async function api(path, options = {}) {
  const res = await fetch(`${API}${path}`, { headers: { "Content-Type": "application/json" }, ...options });
  if (!res.ok) throw new Error(await res.text().catch(()=>"Request failed"));
  return await res.json();
}

/* ===== State ===== */
let players = [];
let active = 0;
let tokenEls = [];

/* ===== UI helpers ===== */
function showPopup(msg, color="#00bfff", isHTML=false) {
  const popup = document.getElementById("popup");
  if (isHTML) popup.innerHTML = msg; else popup.textContent = msg;
  popup.style.background = `linear-gradient(135deg, ${color}, #00b3ff)`;
  popup.classList.add("show");
  clearTimeout(popup._t);
  popup._t = setTimeout(() => popup.classList.remove("show"), 2500);
}
function sidebarColor(i) {
  return ["#00bfff", "#ff4b5c", "#ffd700", "#00ff88", "#ff9f1c", "#9b5de5"][i % 6];
}
function pieceFileFor(i, fallback) {
  return fallback || ["busPiece.png", "wingPiece.png", "mascotPiece.png", "turkeyPiece.png"][i % 4];
}

/* ===== Render sidebar ===== */
function renderSidebar() {
  const el = document.getElementById("playerSidebar");
  el.innerHTML = `<h2>üéÆ Players</h2>`;
  players.forEach((p, i) => {
    const card = document.createElement("div");
    card.className = "player-card" + (i === active ? " active" : "");
    card.style.borderLeftColor = sidebarColor(i);
    card.innerHTML = `
      <div class="player-info">
        <div class="player-name">${p.name}</div>
        <div class="player-balance">üíµ $${p.balance}</div>
      </div>
      <div class="player-piece">${p.piece ? `<img src="Images/${p.piece}" alt="${p.name} piece" />` : ""}</div>
    `;
    el.appendChild(card);
  });
  const hasJailFree = (players[active]?.cards || []).some(c => c.id === "jail_free" || c.id === "cc_jail_free");
  document.getElementById("useCardBtn").style.display = hasJailFree ? "" : "none";
}

/* ===== Tokens ===== */
function ensureTokens() {
  const board = document.getElementById("board");
  tokenEls.forEach(t => t.remove());
  tokenEls = [];
  players.forEach((p, i) => {
    const d = document.createElement("div");
    d.className = "token";
    d.innerHTML = p.piece ? `<img src="Images/${p.piece}" alt="${p.name} token" />` : "üé≤";
    board.appendChild(d);
    tokenEls.push(d);
  });
}

function placeWithMargin(xPct, yPct, rect) {
  const MARGIN = 9;
  const sx = MARGIN + (xPct * (100 - 2 * MARGIN) / 100);
  const sy = MARGIN + (yPct * (100 - 2 * MARGIN) / 100);
  return {
    left: (sx / 100) * rect.width,
    top:  (sy / 100) * rect.height
  };
}

function positionTokens() {
  const holder = document.getElementById("boardImgHolder");
  const rect = holder.getBoundingClientRect();
  players.forEach((p, i) => {
    const [xPct, yPct] = p.coords || [100, 100];
    const token = tokenEls[i];
    const { left, top } = placeWithMargin(xPct, yPct, rect);
    const offset = [ {dx:0,dy:0}, {dx:-1.4,dy:-1.4}, {dx:1.4,dy:-1.4}, {dx:-1.4,dy:1.4}, {dx:1.4,dy:1.4} ][i % 5];
    token.style.left = `${left + offset.dx}px`;
    token.style.top  = `${top  + offset.dy}px`;
  });
}

/* ===== Modal (My Properties) ===== */
const modalBackdrop = document.getElementById("modalBackdrop");
document.getElementById("modalClose").onclick = () => modalBackdrop.style.display = "none";
document.getElementById("propsBtn").onclick = () => {
  const p = players[active];
  const list = document.getElementById("propList");
  list.innerHTML = "";
  if (!p || !p.properties || p.properties.length === 0) {
    list.innerHTML = `<span class="pill" style="grid-column: 1 / span 2; opacity:.8">No properties owned yet.</span>`;
  } else {
    p.properties.forEach(name => {
      const item = document.createElement("div");
      item.className = "pill";
      item.textContent = name;
      list.appendChild(item);
      const owned = document.createElement("div");
      owned.style.textAlign = "right";
      owned.style.opacity = ".8";
      owned.textContent = "‚Ä¢ owned";
      list.appendChild(owned);
    });
  }
  modalBackdrop.style.display = "flex";
};
modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) modalBackdrop.style.display = "none"; });

/* ===== Backend bootstrapping ===== */
async function ensureBackendPlayers() {
  try {
    const existing = await api("/state");
    if ((existing.players || []).length > 0) return;
  } catch {}
  try {
    const stored = JSON.parse(sessionStorage.getItem("players") || "[]");
    const body = stored.length ? { players: stored } : {
      players: [
        { name: "Player 1", piece: "busPiece.png" },
        { name: "Player 2", piece: "wingPiece.png" },
        { name: "Player 3", piece: "mascotPiece.png" },
        { name: "Player 4", piece: "turkeyPiece.png" },
      ]
    };
    await api("/init_players", { method: "POST", body: JSON.stringify(body) });
  } catch {}
}

async function loadState() {
  const data = await api("/state");
  players = (data.players || []).map((p, i) => ({ ...p, piece: p.piece || pieceFileFor(i, p.piece) }));
  active = data.active_player ?? 0;
  renderSidebar();
  ensureTokens();
  positionTokens();
}

/* ===== Buttons ===== */
document.getElementById("rollBtn").onclick = async () => {
  try {
    const data = await api("/roll", { method: "POST" });
    document.getElementById("diceDisplay").textContent = data.roll ?? "-";
    if (data.message) showPopup(data.message, "#00ffcc");
    players = data.players; active = data.active_player ?? active;
    renderSidebar(); ensureTokens(); positionTokens();
  } catch (e) { showPopup("Backend error: " + e.message, "#ff5c6b"); }
};

document.getElementById("buyBtn").onclick = async () => {
  try {
    const data = await api("/buy", { method: "POST" });
    if (data.error) showPopup(data.error, "#ff6b6b"); else showPopup(data.message || "Purchased.", "#ffb300");
    players = data.players; active = data.active_player ?? active;
    renderSidebar();
  } catch (e) { showPopup("Backend error: " + e.message, "#ff5c6b"); }
};

document.getElementById("useCardBtn").onclick = async () => {
  try {
    let out = await api("/use_card", { method: "POST", body: JSON.stringify({ card_id: "jail_free" }) });
    if (out.error) out = await api("/use_card", { method: "POST", body: JSON.stringify({ card_id: "cc_jail_free" }) });
    if (out.error) showPopup(out.error, "#ff6b6b"); else showPopup(out.message || "Card used.", "#7ee787");
    players = out.players; active = out.active_player ?? active;
    renderSidebar();
  } catch (e) { showPopup("Backend error: " + e.message, "#ff5c6b"); }
};

document.getElementById("endTurnBtn").onclick = async () => {
  try {
    const data = await api("/end_turn", { method: "POST" });
    showPopup(`Turn ended. ${data.next_player}'s turn!`, "#4a9eff");
    players = data.players; active = data.active_player ?? 0;
    renderSidebar();
  } catch (e) { showPopup("Backend error: " + e.message, "#ff5c6b"); }
};

document.getElementById("resetBtn").onclick = async () => {
  try {
    const data = await api("/reset", { method: "POST" });
    showPopup("Game reset.", "#9be9a8");
    players = data.players; active = data.active_player ?? 0;
    renderSidebar(); ensureTokens(); positionTokens();
    document.getElementById("diceDisplay").textContent = "‚Äì";
  } catch (e) { showPopup("Backend error: " + e.message, "#ff5c6b"); }
};

/* ===== Property hover info (kept) ===== */
function showTileInfo(tileEl) {
  const name = tileEl.title;
  const info = propertyInfo[name];
  if (!info) return;
  const rentHouses = info.rent.house.join(", ");
  showPopup(`${name} <br> Color: ${info.color} <br> Price: $${info.price} <br> Rent (houses): ${rentHouses} <br> Rent (hotel): $${info.rent.hotel}`, "#00bfff", true);
}
document.querySelectorAll(".tile").forEach(tile => {
  tile.addEventListener("mouseenter", () => showTileInfo(tile));
});

/* ===== Init ===== */
(async function init() {
  await ensureBackendPlayers();
  await loadState();
  window.addEventListener("resize", positionTokens);
})();
</script>
<script>
/* Property info blob (you can keep yours; sample shown) */
const propertyInfo = {
  "Baird": { color:"brown", price:60, rent:{house:[2,10,30,90,160], hotel:250} },
  "Clements": { color:"brown", price:60, rent:{house:[4,20,60,180,320], hotel:450} },
  "Baldy": { color:"light blue", price:100, rent:{house:[6,30,90,270,400], hotel:550} },
  "Jacobs": { color:"light blue", price:100, rent:{house:[6,30,90,270,400], hotel:550} },
  "Park": { color:"light blue", price:120, rent:{house:[8,40,100,300,450], hotel:600} },
  "O'Brian": { color:"pink", price:140, rent:{house:[8,40,100,300,450], hotel:600} },
  "Norton": { color:"pink", price:140, rent:{house:[8,40,100,300,450], hotel:600} },
  "Knox": { color:"pink", price:160, rent:{house:[10,50,150,450,625], hotel:750} },
  "Bonner": { color:"orange", price:180, rent:{house:[10,50,150,450,625], hotel:750} },
  "Talbert": { color:"orange", price:180, rent:{house:[10,50,150,450,625], hotel:750} },
  "Hochstetter": { color:"orange", price:200, rent:{house:[12,60,180,500,700], hotel:750} },
  "Cooke": { color:"red", price:220, rent:{house:[22,110,330,800,1000], hotel:900} },
  "Fronczak": { color:"red", price:220, rent:{house:[22,110,330,800,1000], hotel:900} },
  "NSC": { color:"red", price:240, rent:{house:[24,120,360,850,1050], hotel:950} },
  "Ketter": { color:"yellow", price:260, rent:{house:[24,120,360,850,1050], hotel:950} },
  "Slee": { color:"yellow", price:260, rent:{house:[26,130,390,900,1100], hotel:1000} },
  "Furnas": { color:"yellow", price:280, rent:{house:[26,130,390,900,1100], hotel:1000} },
  "The Commons": { color:"green", price:300, rent:{house:[28,150,450,1000,1200], hotel:1050} },
  "Center for the Arts": { color:"green", price:300, rent:{house:[28,150,450,1000,1200], hotel:1050} },
  "Alumni Arena": { color:"green", price:320, rent:{house:[30,160,500,1100,1300], hotel:1100} },
  "Davis": { color:"dark blue", price:350, rent:{house:[35,175,500,1200,1400], hotel:1200} },
  "Jarvis": { color:"dark blue", price:400, rent:{house:[50,200,600,1400,1700], hotel:1400} }
};
</script>
</body>
</html>
