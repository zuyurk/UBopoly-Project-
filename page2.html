<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UBHACKOPOLY – Player Setup</title>
  <style>
    :root{ --sky-1:#e6f4ff; --sky-2:#bfe4f2; --ink:#1d2230; --tile:#f2e9d7; --shadow:0 12px 30px rgba(0,0,0,.18); --accent:#0b5fbf; --accent-soft:rgba(11,95,191,.15); }
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--ink);
      background:
        url("monopoly board.jpg") center / contain no-repeat,
        url("Images/moneyBackground.avif") center / cover no-repeat fixed;
      display:grid; place-items:center;
    }
    .stage{ width:min(96vw,1200px); aspect-ratio:8/5; position:relative; }
    .sky{
      position:absolute; inset:10px; background:radial-gradient(120% 90% at 50% 10%, var(--sky-1), var(--sky-2));
      border-radius:18px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:clamp(14px,3vw,30px); padding:clamp(12px,2vw,28px); text-align:center;
    }
    .back-btn{
      position:absolute; top:14px; left:14px; display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:12px; background:#ffffffcc; color:#0b5fbf; border:2px solid #d5e6ff;
      box-shadow:0 6px 16px rgba(0,0,0,.12); cursor:pointer; font-weight:700; text-decoration:none;
    }
    .subtitle{ font-weight:800; letter-spacing:.12em; text-transform:uppercase; color:#0b5fbf; font-size:clamp(14px,2.8vw,32px); }
    .name-row{ width:min(90%,720px); margin:0 auto; }
    .name-input{
      width:100%; font-size:clamp(14px,2.4vw,22px); padding:14px 16px; border-radius:14px; border:2px solid rgba(0,0,0,.1);
      outline:none; background:#ffffffd9; box-shadow:0 8px 18px rgba(0,0,0,.12);
    }
    .pieces-grid{
      width:min(90%,720px); margin:0 auto; display:grid; grid-template-columns:repeat(4,1fr);
      gap:clamp(12px,2vw,20px); justify-items:center;
    }
    .piece{ width:100%; aspect-ratio:1/1; border-radius:14px; background:var(--tile); border:3px dashed #c6bda7; box-shadow:var(--shadow);
      display:grid; place-items:center; cursor:pointer; transition:transform .12s, box-shadow .12s, border-color .12s, background .12s, filter .12s; overflow:hidden;}
    .piece.selected{ border-style:solid; border-color:var(--accent); background:#fff; box-shadow:0 0 0 4px var(--accent-soft); }
    .piece img{ width:80%; height:80%; object-fit:contain; filter:drop-shadow(0 6px 12px rgba(0,0,0,.18)); }
    .actions{ width:min(90%,720px); display:flex; justify-content:center; }
    .btn-continue{ padding:14px 24px; border-radius:14px; background:linear-gradient(180deg,#0b5fbf,#074aa0); color:#fff; font-weight:800; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <div class="stage" role="main" aria-label="UBHACKOPOLY Player Setup">
    <div class="sky">
      <a class="back-btn" href="page1.html">← Back</a>
      <div class="subtitle" id="subtitle">Player Setup</div>

      <div class="name-row">
        <input class="name-input" id="username" type="text" placeholder="Enter your username" aria-label="Username" />
      </div>

      <div class="pieces-grid" role="group" aria-label="Choose your piece">
        <button class="piece" data-piece="busPiece.png"><img src="Images/busPiece.png" alt="Bus" /></button>
        <button class="piece" data-piece="wingPiece.png"><img src="Images/wingPiece.png" alt="Wing" /></button>
        <button class="piece" data-piece="mascotPiece.png"><img src="Images/mascotPiece.png" alt="Mascot" /></button>
        <button class="piece" data-piece="turkeyPiece.png"><img src="Images/turkeyPiece.png" alt="Turkey" /></button>
      </div>

      <div class="actions">
        <button class="btn-continue" id="continueBtn">Continue</button>
      </div>
    </div>
  </div>

<script>
  const API = (location.protocol === "file:" || location.port !== "5000")
    ? "http://127.0.0.1:5000"
    : location.origin;

  const params = new URLSearchParams(window.location.search);
  const totalPlayers = Math.max(1, parseInt(params.get('count') || '1', 10));
  const players = [];
  let i = 0;
  let selectedPiece = null;

  const subtitle = document.getElementById('subtitle');
  const usernameEl = document.getElementById('username');
  const pieceButtons = Array.from(document.querySelectorAll('.piece'));

  function renderStep() {
    subtitle.textContent = `Player Setup (${i + 1} / ${totalPlayers})`;
    usernameEl.value = players[i]?.name || '';
    selectedPiece = players[i]?.piece || null;
    pieceButtons.forEach(btn => {
      const p = btn.dataset.piece;
      const takenElsewhere = players.some((pp, idx) => idx !== i && pp?.piece === p);
      btn.disabled = takenElsewhere;
      btn.classList.toggle('selected', selectedPiece === p);
      btn.style.opacity = takenElsewhere ? .45 : 1;
    });
    usernameEl.focus();
  }

  pieceButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.disabled) return;
      pieceButtons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedPiece = btn.dataset.piece;
    });
  });

  document.getElementById('continueBtn').addEventListener('click', async () => {
    const name = usernameEl.value.trim();
    if (!name || !selectedPiece) { alert('Please enter a name and pick a piece.'); return; }
    players[i] = { name, piece: selectedPiece };

    if (i + 1 < totalPlayers) {
      i += 1;
      renderStep();
      return;
    }

    // Persist locally (fallback)
    sessionStorage.setItem('players', JSON.stringify(players));
    sessionStorage.setItem('playerCount', String(totalPlayers));

    // POST to backend /init_players (best effort)
    try {
      await fetch(`${API}/init_players`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ players })
      });
    } catch (e) {
      // If backend unavailable, continue anyway (page3 will use sessionStorage)
      console.warn("init_players failed:", e);
    }

    window.location.href = 'page3.html';
  });

  renderStep();
</script>
</body>
</html>
