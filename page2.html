<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UBHACKOPOLY â€“ Player Setup</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body {
    height: 100%;
    font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: radial-gradient(circle at top, #0b1335, #02040a 85%);
    color: #fff;
  }
  .wrap {
    max-width: 1100px; margin: 26px auto; padding: 16px;
  }
  h1 { font-size: clamp(1.4rem, 2.6vw, 2rem); color: #bde3ff; text-shadow: 0 0 10px rgba(0,180,255,.45); margin-bottom: 14px; }
  p  { opacity: .85; margin-bottom: 18px; }
  .grid {
    display: grid; gap: 16px;
    grid-template-columns: repeat(2, minmax(280px, 1fr));
  }
  .card {
    background: rgba(255,255,255,.08);
    border: 2px solid rgba(255,255,255,.15);
    border-radius: 16px;
    padding: 16px;
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 30px rgba(0,0,0,.35);
  }
  .card h2 { font-size: 1.05rem; margin-bottom: 8px; color:#9fd4ff; }
  label { display:block; font-size:.9rem; opacity:.9; margin: 8px 0 6px; }
  input[type="text"]{
    width: 100%; padding: 10px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.22); background:rgba(0,0,0,.25); color:#fff;
    outline:none;
  }
  .pieces {
    display: grid; gap: 10px; grid-template-columns: repeat(4, 1fr); margin-top: 10px;
  }
  .piece {
    border: 2px solid transparent; border-radius: 12px; padding: 8px;
    background: rgba(255,255,255,.06); cursor: pointer; text-align: center;
    transition: transform .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .piece img { width: 56px; height: 56px; object-fit: contain; filter: drop-shadow(0 3px 6px rgba(0,0,0,.45)); }
  .piece span { display:block; font-size: .85rem; margin-top: 6px; opacity: .9; }
  .piece:hover { transform: translateY(-2px); box-shadow: 0 0 0 3px rgba(0,180,255,.25) inset; }
  .piece.selected { border-color: #00b0ff; box-shadow: 0 0 0 3px rgba(0,180,255,.35) inset; }

  .actions {
    display: flex; gap: 12px; margin-top: 18px; flex-wrap: wrap;
  }
  button {
    border: none; border-radius: 12px; padding: 12px 16px; cursor: pointer;
    font-weight: 700; color: #fff; background: linear-gradient(135deg,#007bff,#4a00e0);
    box-shadow: 0 0 18px rgba(0,136,255,.25); transition: transform .15s ease, box-shadow .2s ease;
  }
  button:hover { transform: translateY(-1px); box-shadow: 0 0 24px rgba(90,50,255,.45); }
  .note { opacity:.9; font-size:.9rem; margin-top: 8px; }

  .topbar {
    display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 16px;
  }
  .pill {
    display:inline-block; padding: 6px 12px; border-radius: 999px;
    border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06);
    font-size:.9rem; opacity:.95;
  }

  @media (max-width: 750px) {
    .grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Player Setup</h1>
      <span class="pill">Step 2 â†’ Choose names & pieces</span>
    </div>
    <p>Pick 2â€“4 players. Each player: add a name and click a token to select it.</p>

    <div class="grid" id="playersGrid">
      <!-- Player cards injected by JS -->
    </div>

    <div class="actions">
      <button id="addPlayerBtn">âž• Add Player</button>
      <button id="removePlayerBtn">âž– Remove Player</button>
      <button id="startBtn">ðŸš€ Start Game</button>
      <span class="note">Weâ€™ll save your picks and send them to the backend on <b>port 5050</b>.</span>
    </div>
  </div>

<script>
/* ===== API base forced to 5050 ===== */
const API = (() => {
  try {
    const isFile = location.protocol === 'file:';
    const isLocal = ['localhost','127.0.0.1','0.0.0.0'].includes(location.hostname);
    if (isFile) return 'http://127.0.0.1:5050';
    if (isLocal) return `http://${location.hostname}:5050`;
    return `${location.origin}`;
  } catch {
    return 'http://127.0.0.1:5050';
  }
})();
async function api(path, options = {}) {
  const res = await fetch(`${API}${path}`, { headers: { "Content-Type": "application/json" }, ...options });
  if (!res.ok) throw new Error(await res.text().catch(()=>"Request failed"));
  return await res.json();
}

/* ===== Player setup state ===== */
const DEFAULT_PIECES = [
  { id:"busPiece.png",    label:"Bus"     },
  { id:"wingPiece.png",   label:"Wing"    },
  { id:"mascotPiece.png", label:"Mascot"  },
  { id:"turkeyPiece.png", label:"Turkey"  },
];
let players = [
  { name: "Player 1", piece: "busPiece.png" },
  { name: "Player 2", piece: "wingPiece.png" },
];

/* ===== Render helpers ===== */
function renderPlayers() {
  const grid = document.getElementById("playersGrid");
  grid.innerHTML = "";
  players.forEach((p, idx) => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h2>Player ${idx + 1}</h2>
      <label for="name_${idx}">Name</label>
      <input id="name_${idx}" type="text" placeholder="Enter name" value="${p.name || ""}" />
      <label style="margin-top:12px;">Choose a token</label>
      <div class="pieces" id="pieces_${idx}">
        ${DEFAULT_PIECES.map(piece => `
          <div class="piece ${p.piece === piece.id ? "selected" : ""}" data-piece="${piece.id}" data-idx="${idx}">
            <img src="Images/${piece.id}" alt="${piece.label}" />
            <span>${piece.label}</span>
          </div>
        `).join("")}
      </div>
    `;
    grid.appendChild(card);
  });

  // attach listeners
  players.forEach((p, idx) => {
    const input = document.getElementById(`name_${idx}`);
    input.addEventListener("input", (e) => { players[idx].name = e.target.value; });

    const container = document.getElementById(`pieces_${idx}`);
    container.querySelectorAll(".piece").forEach(el => {
      el.addEventListener("click", () => {
        const selectedPiece = el.dataset.piece;

        // Check if another player already has this piece
        const alreadyChosen = players.some((player, i) => i !== idx && player.piece === selectedPiece);
        if (alreadyChosen) {
          alert("This token is already taken by another player! Choose a different one.");
          return;
        }

        // Update selection
        players[idx].piece = selectedPiece;

        // Toggle selection visuals
        container.querySelectorAll(".piece").forEach(k => k.classList.remove("selected"));
        el.classList.add("selected");
      });
    });
  });
}

/* ===== Add/Remove player ===== */
document.getElementById("addPlayerBtn").addEventListener("click", () => {
  if (players.length >= 4) return alert("Max 4 players.");
  const next = players.length + 1;
  const nextPiece = DEFAULT_PIECES[next - 1]?.id || DEFAULT_PIECES[0].id;
  players.push({ name: `Player ${next}`, piece: nextPiece });
  renderPlayers();
});
document.getElementById("removePlayerBtn").addEventListener("click", () => {
  if (players.length <= 2) return alert("At least 2 players required.");
  players.pop();
  renderPlayers();
});

/* ===== Start game: save to session + send to backend + go page3 ===== */
document.getElementById("startBtn").addEventListener("click", async () => {
  // validation: names non-empty & unique pieces
  for (const p of players) {
    if (!p.name || !p.name.trim()) return alert("Please enter all player names.");
    if (!p.piece) return alert("Please choose a token for each player.");
  }

  // Save locally so page3 can bootstrap
  sessionStorage.setItem("players", JSON.stringify(players));

  try {
    await api("/init_players", { method: "POST", body: JSON.stringify({ players }) });
  } catch (e) {
    console.warn("Init on server failed (continuing anyway):", e);
  }

  location.href = "page3.html";
});

/* ===== Init render ===== */
renderPlayers();
</script>
</body>
</html>
